var push_event,chat_event;
var pusher;

push_event = function(userid) {
  var channel;
  if (typeof(pusher) === "undefined") {
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.log(message);
      }
    };
    pusher = new Pusher('e7d1b74dd30352eddd81');
    channel = pusher.subscribe('user_' + userid);
    channel.bind('matching', function(data) {
      $.get("/entry", {  matching_from: data.matching_to,
                          matching_to: data.matching_from }, function (data) {

      });
    });
    channel.bind('cancelled', function() {
      $.ajax({
        type: 'POST',
        url: '/entries'
//        data: data,
//        dataType: 'script'
      });
    });
    channel.bind('starting', function(data) {
      if (data.event_type === "confirm") {
        $(".start-conversation").attr("data-method", "post");
        $(".start-conversation").data("method", "post");
        $(".start-conversation").removeAttr('data-remote');
        $(".start-conversation").removeData('remote');
      }else{
        alert("ajax start");
        var url = '/conversations/' + data.room_id;
        $.ajax({
          type: 'GET',
          url: url,
          data: {
            sender_id: data.recipient_id,
            recipient_id: data.sender_id,
            your_id: data.recipient_id
          },
          error: function(err) {
            alert(err+" did happen, please retry");
          }
        });
      }
    });
  } else {
    console.log("pusher already exists");
  }
};

chat_event = function() {
  if (typeof(pusher) === "undefined"){
    var userid = $(".chatboxoptions").data("userid");
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.log(message);
      }
    };

    if (userid) {
      var channel;
      pusher = new Pusher('e7d1b74dd30352eddd81');
      channel = pusher.subscribe('user_' + userid);
      channel.bind('chat_event', function (data) {
        var path,sender_id,recipient_id;
        path = '/conversations/' + data.message.conversation_id + '/messages';
        sender_id = data.message.user_id;
        recipient_id = $(".chatboxoptions").data("userid");
        $.get(path, { message: data.message, your_id: userid }, function(data) {

        });
      });
    }
  }
};
$('.conversations').ready(function () {
  chat_event();
});
